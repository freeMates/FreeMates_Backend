<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>회원가입 :: FreeMates</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" th:href="@{/css/default.css}">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script th:src="@{/js/common.js}"></script>
  <style>
    /* 회원가입 페이지 스타일 수정 */
    #signup-steps {
      position: relative;
      height: auto;
      min-height: calc(100vh - 180px);
      overflow: hidden;
    }

    .step {
      position: absolute;
      width: 100%;
      padding: 20px 0;
      transition: transform 0.5s ease;
      transform: translateX(100%); /* 기본값은 오른쪽에 위치 */
    }

    .step.next {
      transform: translateX(100%); /* 다음 단계 (오른쪽) */
      z-index: 1;
    }

    .step.active {
      transform: translateX(0); /* 현재 단계 (중앙) */
      z-index: 3;
    }

    .step.prev {
      transform: translateX(-100%); /* 이전 단계 (왼쪽) */
      z-index: 2;
    }

    .input-group {
      margin-bottom: 30px;
      position: relative;
      display: flex;
      justify-content: center;
    }

    .input-group input,
    .input-group select {
      position: relative;
      width: 100%;
      max-width: 327px;
      height: 48px;
    }

    /* 버튼 위치 수정 - container 내부로 위치 조정 */
    .button-bottom {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 40px;
      text-align: center;
      z-index: 100;
      padding: 0;
      width: 100%;
      max-width: 400px;
      background: #fff;
    }

    h2 {
      margin-top: 30px;
      margin-bottom: 30px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
    }

    #sendEmailBtn {
      position: absolute;
      right: 45px;
      top: 8px;
      z-index: 10;
      border-radius: 20px;
      font-size: 14px;
      padding: 5px 10px;
      background-color: #CCF6FF;
      border: none;
    }

    #timer {
      text-align: center;
      color: #FF0000;
      font-size: 14px;
      margin-bottom: 10px;
    }

    /* 버튼 스타일 명시적 정의 */
    .btn-custom {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      padding: 15px 20px;
      gap: 10px;
      width: 327px;
      height: 48px;
      margin: 0 auto;
      border-radius: 50px;
      font-size: 16px;
      font-weight: bold;
      box-shadow: 0px 0px 6px rgba(0, 0, 0, 0.16);
    }

    .btn-custom:enabled {
      background: #CCF6FF;
    }

    .btn-custom:disabled {
      background: #F4F4F4;
    }
  </style>
</head>
<body>
<div class="master-layout-container">
  <!-- 헤더 -->
  <header>
    <div class="signup-header d-flex flex-column py-2 mb-3">
      <div class="d-flex align-items-center w-100">
        <a href="#" class="back-link">
          <img th:src="@{/images/back.png}" alt="뒤로가기" class="back-icon" width="24" height="24">
        </a>
        <div class="step-indicator ms-auto me-auto">
          <span>회원가입 1/3</span>
        </div>
      </div>
      <div class="d-flex justify-content-center mt-3 mb-1 w-100">
        <div style="display: flex; gap: 8px; width: 80%;">
          <div th:each="i : ${#numbers.sequence(1, 3)}"
               style="flex: 1; height: 8px; border-radius: 4px; background-color: #F4F4F4;"
               th:id="'progress-' + ${i}">
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- 컨텐츠 영역 -->
  <main class="d-flex flex-column" style="padding-bottom: 100px; /* 버튼을 위한 여백 */">
    <div id="signup-steps">
      <!-- Step 1: 계정 정보 입력 -->
      <div class="step" id="step1">
        <h2>계정 정보 입력</h2>
        <form id="signup-form-step1" class="mb-3">
          <div class="input-group mb-4">
            <input type="text" id="username" name="username" class="form-control" placeholder="아이디를 입력해주세요." required>
          </div>
          <div class="input-group mb-4">
            <input type="password" id="password" name="password" class="form-control" placeholder="비밀번호를 입력해주세요." required>
          </div>
          <div class="input-group mb-4">
            <input type="password" id="passwordConfirm" name="passwordConfirm" class="form-control" placeholder="비밀번호를 다시 입력해주세요." required>
          </div>
        </form>
      </div>

      <!-- Step 2: 이메일 인증 -->
      <div class="step" id="step2">
        <h2>이메일 인증</h2>
        <form id="signup-form-step2">
          <div class="input-group mb-3">
            <input type="email" id="email" name="email" class="form-control" placeholder="이메일을 입력해주세요." required>
            <button type="button" id="sendEmailBtn" class="btn">인증메일 발송</button>
          </div>
          <div id="timer" style="display: none;">3:00</div>
          <div class="input-group mb-3">
            <input type="text" id="verificationCode" name="verificationCode" class="form-control" placeholder="인증 코드를 입력해주세요." required>
          </div>
        </form>
      </div>

      <!-- Step 3: 회원 정보 입력 (닉네임, 성별, 출생년도) -->
      <div class="step" id="step3">
        <h2>회원 정보 입력</h2>
        <form id="signup-form-step3">
          <div class="input-group mb-4">
            <input type="text" id="nickname" name="nickname" class="form-control" placeholder="닉네임을 입력해주세요." required>
          </div>
          <div class="input-group mb-4">
            <select id="gender" name="gender" class="form-control" required>
              <option value="" disabled selected>성별을 선택해주세요.</option>
              <option value="male">남성</option>
              <option value="female">여성</option>
            </select>
          </div>
          <div class="input-group mb-4">
            <input type="number" id="birthYear" name="birthYear" class="form-control" placeholder="출생년도를 입력해주세요 (예: 1990)" required>
          </div>
        </form>
      </div>
    </div>
  </main>

  <!-- 버튼 영역을 메인 외부로 이동 -->
  <div class="button-bottom">
    <button type="button" class="btn-custom" id="step1-btn" disabled>확인</button>
    <button type="button" class="btn-custom" id="step2-btn" style="display: none;" disabled>이메일 확인</button>
    <button type="button" class="btn-custom" id="step3-btn" style="display: none;" disabled>완료</button>
  </div>
</div>

<!-- JavaScript 로직 -->
<script th:inline="javascript">
  let currentStep = 1;
  const totalSteps = 3; // 3단계로 변경
  let usernameValid = false;
  let passwordValid = false;

  $(document).ready(function() {
    // 초기 설정: 모든 스텝의 상태 설정
    initializeSteps();

    // 이벤트 핸들러 설정
    setupEventHandlers();

    // 첫 번째 버튼은 임시로 활성화 (테스트용)
    $('#step1-btn').prop('disabled', false);
  });

  function initializeSteps() {
    // 모든 스텝을 보이게 하고 위치 초기화
    $('.step').css('display', 'block');

    // 첫 번째 스텝은 활성화, 나머지는 오른쪽에 배치
    $('#step1').addClass('active');
    $('#step2, #step3').addClass('next');

    // 프로그레스바 초기화
    updateProgressBar(1);
  }

  function updateProgressBar(step) {
    // 프로그레스바 업데이트
    for (let i = 1; i <= totalSteps; i++) {
      if (i <= step) {
        $('#progress-' + i).css('background-color', '#CCF6FF');
      } else {
        $('#progress-' + i).css('background-color', '#F4F4F4');
      }
    }

    // 단계 표시 업데이트
    $('.step-indicator span').text('회원가입 ' + step + '/' + totalSteps);

    // 버튼 표시/숨김 처리
    $('.btn-custom').hide();
    $('#step' + step + '-btn').show();
  }

  function goToStep(newStep, direction) {
    if (newStep < 1 || newStep > totalSteps) return;

    const oldStep = currentStep;

    if (direction > 0) {
      // 다음 단계로 이동 (오른쪽에서 왼쪽으로)
      $('#step' + oldStep).removeClass('active').addClass('prev');
      $('#step' + newStep).removeClass('next').addClass('active');
    } else {
      // 이전 단계로 이동 (왼쪽에서 오른쪽으로)
      $('#step' + oldStep).removeClass('active').addClass('next');
      $('#step' + newStep).removeClass('prev').addClass('active');
    }

    // 현재 스텝 업데이트
    currentStep = newStep;
    updateProgressBar(newStep);
  }

  function setupEventHandlers() {
    // 뒤로 가기 버튼
    $('.back-link').click(function(e) {
      e.preventDefault();
      if (currentStep > 1) {
        goToStep(currentStep - 1, -1); // -1은 이전으로 이동
      } else {
        window.location.href = '/login';
      }
    });

    // 스텝 1: 계정 정보 검증
    let timeout;
    $('#username').on('input', function() {
      clearTimeout(timeout);
      timeout = setTimeout(function() {
        usernameValid = $('#username').val().length >= 4;
        updateButtonState(1);
      }, 500);
    });

    $('#password, #passwordConfirm').on('input', function() {
      const password = $('#password').val();
      const passwordConfirm = $('#passwordConfirm').val();
      passwordValid = password.length >= 6 && password === passwordConfirm;
      updateButtonState(1);
    });

    // 스텝 2: 이메일 인증
    $('#sendEmailBtn').click(function() {
      $('#timer').show();
      startTimer();

      $('#verificationCode').on('input', function() {
        if ($(this).val().length > 0) {
          $('#step2-btn').prop('disabled', false);
        } else {
          $('#step2-btn').prop('disabled', true);
        }
      });
    });

    // 스텝 3: 회원 정보 입력 (닉네임, 성별, 출생년도)
    $('#nickname, #gender, #birthYear').on('input change', function() {
      const nicknameValid = $('#nickname').val().length > 0;
      const genderSelected = $('#gender').val() !== null && $('#gender').val() !== "";
      const birthYearValid = $('#birthYear').val().length === 4 &&
          Number($('#birthYear').val()) >= 1900 &&
          Number($('#birthYear').val()) <= new Date().getFullYear();

      $('#step3-btn').prop('disabled', !(nicknameValid && genderSelected && birthYearValid));
    });

    // 다음 버튼 클릭
    $('.btn-custom').click(function() {
      if (currentStep < totalSteps) {
        goToStep(currentStep + 1, 1); // 1은 다음으로 이동
      } else {
        // 회원가입 완료 처리
        alert('회원가입이 완료되었습니다!');
        window.location.href = '/login';
      }
    });
  }

  function updateButtonState(step) {
    if (step === 1) {
      // FIXME: 임시 허용
      $('#step1-btn').prop('disabled', false);
      // 실제 구현 시 아래 코드로 변경
      // $('#step1-btn').prop('disabled', !(usernameValid && passwordValid));
    }
  }

  function startTimer() {
    let time = 180; // 3분
    let timerInterval = setInterval(function() {
      let minutes = Math.floor(time / 60);
      let seconds = time % 60;
      $('#timer').text(minutes + ':' + (seconds < 10 ? '0' : '') + seconds);
      time--;

      if (time < 0) {
        clearInterval(timerInterval);
        $('#timer').text('시간 초과');
        $('#step2-btn').prop('disabled', true);
      }
    }, 1000);
  }
</script>
</body>
</html>